// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Family {
  id                String   @id @default(cuid())
  phone             String?  @unique
  waId              String?  @unique
  lang              Language @default(EN)
  clientCode        String   @unique @map("client_code")
  kidsCount         Int?
  consentMarketing  Boolean  @default(false) @map("consent_marketing")
  consentGdpr       Boolean  @default(false) @map("consent_gdpr")
  onboardingStatus  String   @default("pending") @map("onboarding_status")
  preferredLanguage String   @default("EN") @map("preferred_language")
  lastActiveAt      DateTime? @map("last_active_at")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  visits         Visit[]
  loyaltyCounter LoyaltyCounter?
  vouchers       Voucher[]
  subscriptions  Subscription[]
  visitCodes     VisitCode[]
  orders         Order[]
  bookings       Booking[]
  consent        Consent?
  dataExports    DataExport[]
  dataDeletionRequests DataDeletionRequest[]

  @@map("families")
}

model Visit {
  id          String      @id @default(cuid())
  familyId    String      @map("family_id")
  source      VisitSource
  staffId     String?     @map("staff_id")
  shiftId     String?     @map("shift_id")
  sourceData  String?     @map("source_data")
  note        String?
  validatedAt DateTime?   @map("validated_at")
  isValidated Boolean     @default(false) @map("is_validated")
  createdAt   DateTime    @default(now()) @map("created_at")

  // Relations
  family      Family      @relation(fields: [familyId], references: [id], onDelete: Cascade)
  staff       Staff?      @relation(fields: [staffId], references: [id])

  @@map("visits")
}

model LoyaltyCounter {
  familyId          String    @id @map("family_id")
  currentCycleCount Int       @default(0) @map("current_cycle_count")
  totalVisits       Int       @default(0) @map("total_visits")
  lastVisitAt       DateTime? @map("last_visit_at")
  cycleStartedAt    DateTime  @default(now()) @map("cycle_started_at")
  cycleCompletedAt  DateTime? @map("cycle_completed_at")

  // Relations
  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@map("loyalty_counters")
}

model Voucher {
  id              String        @id @default(cuid())
  familyId        String        @map("family_id")
  code            String        @unique
  qrData          String?       @map("qr_data")
  status          VoucherStatus @default(ACTIVE)
  issuedAt        DateTime      @default(now()) @map("issued_at")
  validUntil      DateTime      @map("valid_until")
  redeemedAt      DateTime?     @map("redeemed_at")
  redeemedByStaffId String?     @map("redeemed_by_staff_id")

  // Relations
  family          Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  redeemedByStaff Staff?        @relation("VoucherRedemption", fields: [redeemedByStaffId], references: [id])

  @@map("vouchers")
}

model MenuItem {
  id      String   @id @default(cuid())
  sku     String   @unique
  nameEn  String   @map("name_en")
  namePt  String   @map("name_pt")
  descEn  String?  @map("desc_en")
  descPt  String?  @map("desc_pt")
  priceCents Int   @map("price_cents")
  category MenuCategory
  isActive Boolean @default(true) @map("is_active")

  // Relations
  orderItems OrderItem[]

  @@map("menu_items")
}

model Subscription {
  id        String   @id @default(cuid())
  familyId  String   @map("family_id")
  topic     SubscriptionTopic
  status    SubscriptionStatus @default(ON)
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  family    Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([familyId, topic])
  @@map("subscriptions")
}

model Staff {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  role         StaffRole
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  visits       Visit[]
  voucherRedemptions Voucher[] @relation("VoucherRedemption")
  visitCodesIssued   VisitCode[] @relation("VisitCodeIssuer")
  broadcasts   Broadcast[]

  @@map("staff")
}

model VisitCode {
  id        String   @id @default(cuid())
  familyId  String   @map("family_id")
  code      String   @unique
  staffId   String?  @map("staff_id")
  isUsed    Boolean  @default(false) @map("is_used")
  usedAt    DateTime? @map("used_at")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  family    Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  staff     Staff?   @relation("VisitCodeIssuer", fields: [staffId], references: [id])

  @@map("visit_codes")
}

model Order {
  id            String      @id @default(cuid())
  familyId      String      @map("family_id")
  items         Json        // массив позиций меню
  totalAmount   Decimal     @map("total_amount")
  status        OrderStatus @default(PENDING)
  paymentMethod String?     @map("payment_method")
  paymentLink   String?     @map("payment_link")
  paymentId     String?     @map("payment_id")
  createdAt     DateTime    @default(now()) @map("created_at")
  paidAt        DateTime?   @map("paid_at")
  confirmedAt   DateTime?   @map("confirmed_at")

  // Relations
  family        Family      @relation(fields: [familyId], references: [id], onDelete: Cascade)
  orderItems    OrderItem[]

  @@map("orders")
}

model OrderItem {
  id         String   @id @default(cuid())
  orderId    String   @map("order_id")
  menuItemId String   @map("menu_item_id")
  quantity   Int
  price      Decimal

  // Relations
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  @@map("order_items")
}

model Event {
  id            String   @id @default(cuid())
  titleEn       String   @map("title_en")
  titlePt       String   @map("title_pt")
  descriptionEn String?  @map("description_en")
  descriptionPt String?  @map("description_pt")
  date          DateTime
  time          String?
  capacity      Int?
  price         Decimal?
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  bookings      Booking[]

  @@map("events")
}

model Booking {
  id        String        @id @default(cuid())
  familyId  String        @map("family_id")
  eventId   String        @map("event_id")
  status    BookingStatus @default(CONFIRMED)
  bookedAt  DateTime      @default(now()) @map("booked_at")
  cancelledAt DateTime?   @map("cancelled_at")
  attendedAt DateTime?    @map("attended_at")
  notes     String?

  // Relations
  family    Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  event     Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("bookings")
}

model Broadcast {
  id            String          @id @default(cuid())
  title         String
  messageEn     String          @map("message_en")
  messagePt     String          @map("message_pt")
  type          BroadcastType
  targetAudience String         @map("target_audience")
  language      String?
  status        BroadcastStatus @default(DRAFT)
  scheduledAt   DateTime?       @map("scheduled_at")
  sentAt        DateTime?       @map("sent_at")
  createdAt     DateTime        @default(now()) @map("created_at")
  createdBy     String          @map("created_by")

  // Relations
  createdByStaff Staff          @relation(fields: [createdBy], references: [id])

  @@map("broadcasts")
}

model Consent {
  id          String   @id @default(cuid())
  familyId    String   @unique @map("family_id")
  type        String   // marketing, gdpr, terms
  granted     Boolean
  grantedAt   DateTime? @map("granted_at")
  withdrawnAt DateTime? @map("withdrawn_at")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")

  // Relations
  family      Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@map("consents")
}

model DataExport {
  id          String   @id @default(cuid())
  familyId    String   @map("family_id")
  status      String   @default("pending")
  filePath    String?  @map("file_path")
  createdAt   DateTime @default(now()) @map("created_at")
  expiresAt   DateTime @map("expires_at")
  downloadedAt DateTime? @map("downloaded_at")

  // Relations
  family      Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@map("data_exports")
}

model AuditLog {
  id        String   @id @default(cuid())
  actorType ActorType @map("actor_type")
  actorId   String?  @map("actor_id")
  action    String
  payload   Json
  createdAt DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}

// Enums
enum Language {
  EN
  PT
}

enum VisitSource {
  CODE
  QR
  DESK
}

enum VoucherStatus {
  ACTIVE
  REDEEMED
  EXPIRED
}

enum MenuCategory {
  FOOD
  DRINKS
}

enum SubscriptionTopic {
  EVENTS
  PROMOS
}

enum SubscriptionStatus {
  ON
  OFF
}

enum StaffRole {
  ADMIN
  CASHIER
}

enum ActorType {
  SYSTEM
  STAFF
}

enum OrderStatus {
  PENDING
  PAID
  CONFIRMED
  CANCELLED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  ATTENDED
}

enum BroadcastType {
  EVENT
  PROMO
  UPDATE
}

enum BroadcastStatus {
  DRAFT
  SCHEDULED
  SENT
  CANCELLED
  PENDING
  FAILED
}


model DataDeletionRequest {
  id           String   @id @default(cuid())
  familyId     String   @map("family_id")
  reason       String?
  status       String   @default("PENDING") // 'PENDING', 'COMPLETED', 'REJECTED'
  requestedAt  DateTime @default(now()) @map("requested_at")
  completedAt  DateTime? @map("completed_at")
  completedBy  String?  @map("completed_by")

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@map("data_deletion_requests")
}
